<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Bajada</title>
    
    <!-- Configuración PWA y Manifiesto --><meta name="theme-color" content="#1f2937">
    <link rel="manifest" href="manifest.json">

    <!-- Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter de Google Fonts (Estilo limpio) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Clase para la flecha de dirección, asegura la transición suave */
        .wind-arrow {
            transition: transform 0.5s ease-out, color 0.5s ease-out;
            transform-origin: center center;
        }

        /* --- MEJORA UX: SKELETON LOADER --- */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .skeleton-loader {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            background-color: #e5e7eb; /* bg-gray-200 */
            border-radius: 0.25rem; /* rounded */
        }
        .skeleton-text-lg {
            height: 1.75rem; /* h-7 */
            width: 50%;
        }
        .skeleton-text-xl {
            height: 1.75rem; /* h-7 */
            width: 60%;
        }
        .skeleton-text-3xl {
            height: 2.25rem; /* h-9 */
            width: 40%;
        }
        .data-content {
            display: none; /* Oculto por defecto, se muestra cuando cargan los datos */
        }

        /* Estilos para el acordeón (summary) */
        details > summary {
            list-style: none; /* Ocultar flecha nativa */
            cursor: pointer;
        }
        details > summary::-webkit-details-marker {
            display: none; /* Ocultar flecha nativa en Safari */
        }
    </style>
</head>
<body class="bg-white text-gray-900 min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        
        <!-- ENCABEZADO PRINCIPAL (LOGO APP Y TÍTULO) --><div class="flex flex-col items-center mb-8 mt-4 md:mt-8">
            <!-- Fila 1: Logo 2 (La Bajada - Título Visual, 25% más pequeño) --><div class="w-full flex justify-center mb-2">
                <a href="https://wa.me/#NUMERO_DE_TELEFONO_PRINCIPAL#?text=Hola%2C%20vi%20el%20reporte%20del%20viento%20en%20La%20Bajada%20y%20me%20gustaria%20contactarlos." target="blank">
                    <img 
                        src="logo2.png" 
                        alt="Logo La Bajada" 
                        class="h-36 md:h-48 w-auto" 
                        onerror="this.style.display='none'">
                </a>
            </div>
            <!-- Fila 2: Título del Spot (Actualizado) -->
            <h2 class="text-3xl font-extrabold text-gray-900 mb-4 text-center">
                Claromeco Kitesurf Spot
            </h2>
        </div>

        
        <!-- Video (Movido FUERA de la tarjeta de viento para mejor jerarquía) --><div class="bg-gray-100 rounded-xl shadow-2xl overflow-hidden mb-6 lg:mb-8 border border-gray-300">
            <iframe 
                class="w-full aspect-video" 
                src="https://www.youtube.com/embed/QWo36gCzZEo?si=hftjioeg4y-dP4FT&autoplay=1&mute=1" 
                title="YouTube video player" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                referrerpolicy="strict-origin-when-cross-origin" 
                allowfullscreen>
            </iframe>
        </div>

        <!-- Sección de Viento Resaltado (DATOS) --><div id="wind-highlight-card" class="mt-6 lg:mt-8 p-6 rounded-xl shadow-2xl transition-all duration-300 bg-gray-100 border border-gray-300">
            
            <!-- MEJORA UX: Veredicto / Status del Spot (Lógica simple) -->
            <div id="verdict-card" class="mb-4 p-3 rounded-lg border border-gray-300 transition-colors duration-300">
                <!-- Título actualizado SIN IA -->
                <p class="text-gray-600 text-xs font-medium text-center">Status del Spot</p>
                <!-- Skeleton Loader -->
                <div id="verdict-data-loader" class="skeleton-loader skeleton-text-xl mx-auto mt-1" style="width: 70%;"></div>
                <!-- Dato Real (Oculto) -->
                <p id="verdict-data" class="data-content text-xl font-extrabold text-gray-900 text-center">Calculando...</p>
            </div>
            <!-- Fin Veredicto -->

            <!-- Datos de Viento -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                
                <div class="p-3 bg-gray-100 rounded-lg flex flex-col justify-center items-center h-full border border-gray-300">
                    <!-- Mejora UX: Etiqueta más pequeña -->
                    <p class="text-gray-600 text-xs mb-1 font-medium">Direccion del viento</p>
                    <div class="flex items-center justify-center gap-2">
                        <!-- Flecha SVG (el color se controla por JS) -->
                        <svg id="wind-arrow" class="wind-arrow w-10 h-10 text-gray-900" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L6 8h3v12h6V8h3l-6-6z"/>
                        </svg>
                        <!-- Skeleton Loader -->
                        <div id="highlight-wind-dir-data-loader" class="skeleton-loader skeleton-text-xl"></div>
                        <!-- Dato Real (Oculto) -->
                        <p class="text-xl font-extrabold text-gray-900 data-content" id="highlight-wind-dir-data">N/A</p>
                    </div>
                </div>

                <!-- SUB-TARJETA DE VELOCIDAD (Con ID para JS) -->
                <div id="wind-speed-sub-card" class="p-3 bg-gray-100 rounded-lg border border-gray-300 transition-colors duration-300">
                    <!-- Mejora UX: Etiqueta más pequeña -->
                    <p class="text-gray-600 text-xs font-medium">Velocidad (Prom.)</p>
                    <!-- Skeleton Loader -->
                    <div id="highlight-wind-speed-data-loader" class="skeleton-loader skeleton-text-3xl mx-auto mt-1"></div>
                    <!-- Dato Real (Oculto) -->
                    <p class="text-3xl font-extrabold text-gray-900 data-content" id="highlight-wind-speed-data">N/A</p>
                </div>
                
                <!-- SUB-TARJETA DE RÁFAGA (Con ID para JS) -->
                <div id="wind-gust-sub-card" class="p-3 bg-gray-100 rounded-lg border border-gray-300 transition-colors duration-300">
                    <!-- Mejora UX: Etiqueta más pequeña -->
                    <p class="text-gray-600 text-xs font-medium">RACHA</p> <!-- CAMBIO DE TEXTO -->
                    <!-- Skeleton Loader -->
                    <div id="highlight-gust-data-loader" class="skeleton-loader skeleton-text-3xl mx-auto mt-1"></div>
                    <!-- Dato Real (Oculto) -->
                    <p class="text-3xl font-extrabold text-gray-900 data-content" id="highlight-gust-data">N/A</p>
                </div>
            </div>
            
            <!-- MEJORA UX: Ubicación del Error de API -->
            <div id="error-message" class="hidden mt-6 p-4 bg-red-600 text-white rounded-lg text-center">
                Error al cargar los datos del clima.
            </div>
        </div>
        <!-- Fin Sección de Viento Resaltado -->

        <!-- INICIO: TARJETA DE PRONÓSTICO WINDGURU -->
        <div class="bg-gray-100 p-6 rounded-xl shadow-2xl flex flex-col mt-6 lg:mt-8 border border-gray-300 overflow-x-auto">
            
            <h3 class="text-xl font-extrabold text-gray-900 mb-4">
                Pronóstico Windguru
            </h3>

                    
            <!-- Script de Windguru (cargará el widget aquí) -->
			
			<script id="wglive_15539_1762630804363">
(function (window, document) {
  var loader = function () {
    var arg = ["spot=15539","uid=wglive_15539_1762630804363","color=light","wj=knots","tj=c","avg_min=0","gsize=400","msize=400","m=29","arrow=y","show=l,n,g,c,f,m"];
    var script = document.createElement("script");
    var tag = document.getElementsByTagName("script")[0];
    script.src = "https://www.windguru.cz/js/wglive.php?"+(arg.join("&"));
    tag.parentNode.insertBefore(script, tag);
  };
  window.addEventListener ? window.addEventListener("load", loader, false) : window.attachEvent("onload", loader);
})(window, document);
</script>
            <!-- <script id="wg_fwdg_8165_29_1762183539313"> -->
                <!-- (function (window, document) { -->
                  <!-- var loader = function () { -->
                    <!-- var arg = ["s=8165" ,"m=29","uid=wg_fwdg_8165_29_1762183539313" ,"wj=knots" ,"tj=c" ,"waj=m" ,"tij=m" ,"odh=0" ,"doh=24" ,"fhours=240" ,"hrsm=2" ,"vt=forecasts" ,"lng=es" ,"p=WINDSPD,GUST,SMER,TMPE"]; -->
                    <!-- var script = document.createElement("script"); -->
                    <!-- var tag = document.getElementsByTagName("script")[0]; -->
                    <!-- script.src = "https://www.windguru.cz/js/widget.php?"+(arg.join("&")); -->
                    <!-- tag.parentNode.insertBefore(script, tag); -->
                  <!-- }; -->
                  <!-- window.addEventListener ? window.addEventListener("load", loader, false) : window.attachEvent("onload", loader); -->
                <!-- })(window, document); -->
            <!-- </script> -->
        
        </div>
        <!-- FIN: TARJETA DE PRONÓSTICO WINDGURU -->

        <!-- Columna de Datos en Vivo (OTROS DATOS) --><div class="bg-gray-100 p-6 rounded-xl shadow-2xl flex flex-col mt-6 lg:mt-8 border border-gray-300">
            
            <ul class="space-y-4 text-lg">
                <!-- Temperatura Exterior --><li class="flex justify-between items-center">
                    <span class="text-gray-600 text-sm flex items-center gap-2">
                        <!-- MEJORA UX: Icono -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048l-1.096 1.096A11.25 11.25 0 0012 21a11.25 11.25 0 006.058-20.957l-1.096 1.096z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 3.75v12.75A3 3 0 0015 13.5a3 3 0 00-3-2.25z" /></svg>
                        Temperatura (Ext.):
                    </span>
                    <!-- Skeleton Loader -->
                    <div id="temp-data-loader" class="skeleton-loader skeleton-text-xl"></div>
                    <!-- Dato Real (Oculto) -->
                    <span class="text-xl font-extrabold text-gray-900 data-content" id="temp-data">
                        Cargando...
                    </span>
                </li>
                <!-- Humedad --><li class="flex justify-between items-center">
                    <span class="text-gray-600 text-sm flex items-center gap-2">
                        <!-- MEJORA UX: Icono -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048l-1.096 1.096A11.25 11.25 0 0012 21a11.25 11.25 0 006.058-20.957l-1.096 1.096z" /></svg>
                        Humedad:
                    </span>
                    <!-- Skeleton Loader -->
                    <div id="humidity-data-loader" class="skeleton-loader skeleton-text-xl"></div>
                    <!-- Dato Real (Oculto) -->
                    <span class="text-xl font-extrabold text-gray-900 data-content" id="humidity-data">
                        Cargando...
                    </span>
                </li>
                <!-- Presión Relativa --><li class="flex justify-between items-center">
                    <span class="text-gray-600 text-sm flex items-center gap-2">
                        <!-- MEJORA UX: Icono -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" /></svg>
                        Presión (Relativa):
                    </span>
                    <!-- Skeleton Loader -->
                    <div id="pressure-data-loader" class="skeleton-loader skeleton-text-xl"></div>
                    <!-- Dato Real (Oculto) -->
                    <span class="text-xl font-extrabold text-gray-900 data-content" id="pressure-data">
                        Cargando...
                    </span>
                </li>
                <!-- Lluvia Diaria --><li class="flex justify-between items-center">
                    <span class="text-gray-600 text-sm flex items-center gap-2">
                        <!-- MEJORA UX: Icono -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m3.75 9v6m-3-3h6M15 12.75H9" /></svg>
                        Lluvia (Diaria):
                    </span>
                    <!-- Skeleton Loader -->
                    <div id="rainfall-daily-data-loader" class="skeleton-loader skeleton-text-xl"></div>
                    <!-- Dato Real (Oculto) -->
                    <span class="text-xl font-extrabold text-gray-900 data-content" id="rainfall-daily-data">
                        Cargando...
                    </span>
                </li>
                <!-- Índice UV --><li class="flex justify-between items-center">
                    <span class="text-gray-600 text-sm flex items-center gap-2">
                        <!-- MEJORA UX: Icono -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12H.75m.386-6.364l1.591 1.591M12 12a2.25 2.25 0 00-2.25 2.25c0 .543.19 1.04.5 1.414.31.374.724.665 1.184.876.46.211.956.314 1.466.314.51 0 1.006-.103 1.466-.314.46-.211.874-.502 1.184-.876.31-.374.5-1.04.5-1.414A2.25 2.25 0 0012 12z" /></svg>
                        Índice UV:
                    </span>
                    <!-- Skeleton Loader -->
                    <div id="uvi-data-loader" class="skeleton-loader skeleton-text-xl"></div>
                    <!-- Dato Real (Oculto) -->
                    <span class="text-xl font-extrabold text-gray-900 data-content" id="uvi-data">
                        Cargando...
                    </span>
                </li>
            </ul>

            <!-- MEJORA UX: Indicador de última actualización -->
            <div class="mt-4 pt-4 border-t border-gray-300 text-right">
                <p id="last-updated" class="text-xs text-gray-500">Actualizando datos...</p>
            </div>
        </div>
        <!-- Fin Otros Datos -->
        
        <!-- FOOTER / LOGOS DE PUBLICIDAD --><footer class="mt-8 pt-4 pb-2 border-t border-gray-300">
            <h3 class="text-center text-sm font-semibold text-gray-600 mb-4 flex justify-center items-center gap-2">
                Contactar Escuelas (WhatsApp)
                <!-- Ícono de WhatsApp (Logotipo oficial más reconocible) --><img class="w-6 h-6" src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png" alt="Logo WhatsApp">
            </h3>
            <div class="flex justify-center items-center gap-6">
                <!-- LOGO CLAROMECO KITEBOARDING CON ENLACE A WHATSAPP -->
                <a href="https://wa.me/542983595133?text=Hola!%20Quiero%20consultar%20por%20clases!" target="blank" class="transition-transform duration-300 hover:scale-105">
                    <img 
                        src="logo.png" 
                        alt="Logo Claromeco Kiteboarding" 
                        class="h-16 md:h-20 w-auto opacity-75 hover:opacity-100 transition-opacity duration-300" 
                        onerror="this.style.display='none'">
                </a>

                <!-- LOGO KUKULKÁN CON ENLACE A WHATSAPP -->
                <a href="https://wa.me/5492223575161?text=Hola!%20Quiero%20consultar%20por%20clases!" target="blank" class="transition-transform duration-300 hover:scale-105">
                    <img 
                        src="logo3.jpg" 
                        alt="Logo Kukulkán Escuela de Kitesurf" 
                        class="h-16 md:h-20 w-auto opacity-75 hover:opacity-100 transition-opacity duration-300" 
                        onerror="this.style.display='none'">
                </a>
            </div>

            <!-- Contacto de Desarrollador -->
            <div class="mt-6 text-center text-xs text-gray-500">
                <p>
                    ¿Sugerencias o reporte de errores?
                    <a href="https://wa.me/5492983500324?text=Hola%2C%20tengo%20una%20sugerencia%20para%20la%20App%20de%20La%20Bajada..." 
                       target="_blank" 
                       class="underline hover:text-gray-400 font-medium">
                        Contactar al desarrollador
                    </a>
                </p>
            </div>
        </footer>
        <!-- Fin FOOTER --></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Registro del Service Worker (PWA) ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js') 
                        .then(registration => {
                            console.log('Service Worker: Instalado y registrado con éxito', registration);
                        })
                        .catch(error => {
                            console.log('Error al registrar el Service Worker:', error);
                        });
                });
            }

            // --- URLs de las Funciones Serverless (Proxy) ---
            const weatherApiUrl = 'api/data';
            //const verdictApiUrl = 'api/verdict'; // API GEMINI (Para Veredicto)
            const windyApiUrl = 'api/windy';   // API WINDY (Para Pronóstico)

            // --- ELEMENTOS DEL DOM (Datos Generales) ---
            const tempEl = document.getElementById('temp-data');
            const humidityEl = document.getElementById('humidity-data');
            const pressureEl = document.getElementById('pressure-data');
            const rainfallDailyEl = document.getElementById('rainfall-daily-data'); 
            const uviEl = document.getElementById('uvi-data'); 
            const errorEl = document.getElementById('error-message');
            const lastUpdatedEl = document.getElementById('last-updated');

            // --- ELEMENTOS DEL DOM (Viento Resaltado) ---
            const windHighlightCard = document.getElementById('wind-highlight-card');
            const highlightWindDirEl = document.getElementById('highlight-wind-dir-data');
            const highlightWindSpeedEl = document.getElementById('highlight-wind-speed-data');
            const highlightGustEl = document.getElementById('highlight-gust-data');
            const windArrowEl = document.getElementById('wind-arrow'); 
            const windSpeedSubCardEl = document.getElementById('wind-speed-sub-card'); 
            const windGustSubCardEl = document.getElementById('wind-gust-sub-card'); 
            
            // --- ELEMENTOS DEL DOM (Veredicto EN VIVO) ---
            const verdictCardEl = document.getElementById('verdict-card');
            const verdictDataEl = document.getElementById('verdict-data');
            const verdictDataLoaderEl = document.getElementById('verdict-data-loader');

            // --- ELEMENTOS DEL DOM (Veredicto PRONÓSTICO IA) ---
            const forecastVerdictCardEl = document.getElementById('forecast-verdict-card');
            const forecastVerdictLoaderEl = document.getElementById('forecast-verdict-loader');
            const forecastVerdictDataEl = document.getElementById('forecast-verdict-data');

            // --- MEJORA UX: IDs de todos los Skeletons y Contenidos ---
            const skeletonLoaderIds = [
                'verdict-data-loader',
                'highlight-wind-dir-data-loader', 'highlight-wind-speed-data-loader', 'highlight-gust-data-loader',
                'temp-data-loader', 'humidity-data-loader', 'pressure-data-loader', 
                'rainfall-daily-data-loader', 'uvi-data-loader'
            ];
            const dataContentIds = [
                'verdict-data',
                'highlight-wind-dir-data', 'highlight-wind-speed-data', 'highlight-gust-data',
                'temp-data', 'humidity-data', 'pressure-data',
                'rainfall-daily-data', 'uvi-data'
            ];

            // --- MEJORA UX: Variable para "Time Ago" ---
            let lastUpdateTime = null;

            // --- MEJORA UX: Función para mostrar/ocultar Skeletons ---
            function showSkeletons(isLoading) {
                // Manejar skeletons de datos principales
                skeletonLoaderIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = isLoading ? 'block' : 'none';
                });
                dataContentIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = isLoading ? 'none' : 'block';
                });

                if (isLoading) {
                    if (lastUpdatedEl) lastUpdatedEl.textContent = 'Actualizando datos...';
                }
            }
            
            // --- MEJORA UX: Función para actualizar "Time Ago" ---
            function updateTimeAgo() {
                if (!lastUpdateTime) return;
                const now = new Date();
                const secondsAgo = Math.round((now - lastUpdateTime) / 1000);
                
                if (secondsAgo < 5) {
                    lastUpdatedEl.textContent = "Actualizado ahora";
                } else if (secondsAgo < 60) {
                    lastUpdatedEl.textContent = `Actualizado hace ${secondsAgo} seg.`;
                } else {
                    lastUpdatedEl.textContent = `Actualizado: ${lastUpdateTime.toLocaleTimeString('es-AR')}`;
                }
            }


            // --- FUNCIÓN: CONVERTIR GRADOS A PUNTO CARDINAL ---
            function convertDegreesToCardinal(degrees) {
                if (degrees === null || isNaN(degrees)) return 'N/A';
                const val = Math.floor((degrees / 22.5) + 0.5);
                const arr = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSO", "SO", "OSO", "O", "ONO", "NO", "NNO"];
                return arr[val % 16];
            }
            
            // --- FUNCIÓN DE VEREDICTO (Lógica simple) ---
            // (Anteriormente 'getSpotVerdict_Fallback')
            function getSpotVerdict(speed, gust, degrees) {
                // Esta función devuelve [texto, [claseFondo, claseBorde]]
                // 1. Chequeo de Peligro (Offshore)
                if (degrees !== null) {
                    if ((degrees > 337.5 || degrees <= 67.5)) {
                        return ["¡PELIGRO! VIENTO DE TIERRA", ['bg-red-400', 'border-red-600']];
                    }
                }
                // 2. Chequeo de Viento (basado en 'speed')
                if (speed === null) {
                    return ["Calculando...", ['bg-gray-100', 'border-gray-300']];
                }
                // 3. Chequeo de Viento Navegable
                if (speed <= 14) {
                    return ["FLOJO...", ['bg-blue-200', 'border-blue-400']];
                } else if (speed <= 18) {
                    return ["¡IDEAL!", ['bg-green-300', 'border-green-500']];
                } else if (speed <= 22) {
                    return ["¡MUY BUENO!", ['bg-yellow-300', 'border-yellow-500']];
                } else if (speed <= 27) {
                    return ["¡FUERTE!", ['bg-orange-300', 'border-orange-500']];
                } else { // > 27
                    if (speed > 33) {
                         return ["¡DEMASIADO FUERTE!", ['bg-purple-400', 'border-purple-600']];
                    } else {
                         return ["¡MUY FUERTE!", ['bg-red-400', 'border-red-600']];
                    }
                }
            }

            // --- CONSTANTES DE CLASES DE COLOR ---
            const allColorClasses = [
                'bg-gray-100', 'border-gray-300',
                'bg-blue-200', 'border-blue-400',
                'bg-green-300', 'border-green-500',
                'bg-yellow-300', 'border-yellow-500',
                'bg-orange-300', 'border-orange-500',
                'bg-red-400', 'border-red-600',
                'bg-purple-400', 'border-purple-600',
            ];

            // --- FUNCIÓN DE UTILIDAD: Para actualizar colores de tarjetas ---
            function updateCardColors(element, newClasses) {
                if (!element) return;
                element.classList.remove(...allColorClasses);
                element.classList.add(...newClasses);
            }

            // --- FUNCIÓN: Obtener clases de color para TARJETA PRINCIPAL (Neutral) ---
            function getMainCardColorClasses(speedInKnots) {
                return ['bg-gray-100', 'border-gray-300'];
            }

            // --- FUNCIÓN: Obtener clases de color para SUB-TARJETA (Lógica Windy) ---
            function getWindyColorClasses(speedInKnots) {
                if (speedInKnots !== null && !isNaN(speedInKnots)) {
                    if (speedInKnots <= 10) {
                        return ['bg-blue-200', 'border-blue-400']; // Azul
                    } else if (speedInKnots <= 16) {
                        return ['bg-green-300', 'border-green-500']; // Verde
                    } else if (speedInKnots <= 21) {
                        return ['bg-yellow-300', 'border-yellow-500']; // Amarillo
                    } else if (speedInKnots <= 27) {
                        return ['bg-orange-300', 'border-orange-500']; // Naranja
                    } else if (speedInKnots <= 33) {
                        return ['bg-red-400', 'border-red-600']; // Rojo
                    } else {
                        return ['bg-purple-400', 'border-purple-600']; // Púrpura
                    }
                }
                return ['bg-gray-100', 'border-gray-300']; // Default (Gris)
            }
            
            // --- FUNCIÓN DE UTILIDAD: Fetch con Reintentos (Exponential Backoff) ---
            async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if ((response.status >= 500 || response.status === 429) && retries > 0) {
                            await new Promise(res => setTimeout(res, delay));
                            return fetchWithBackoff(url, options, retries - 1, delay * 2);
                        }
                        let errorText = await response.text();
                        try {
                            const errorJson = JSON.parse(errorText);
                            errorText = errorJson.error || errorText;
                        } catch (e) {
                            // No era JSON, usar el texto plano
                        }
                        throw new Error(errorText);
                    }
                    return response.json();
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    throw error; // Lanzar el error final
                }
            }

            // --- NUEVAS Funciones de Ayuda (Procesar datos de Windy) ---
            function convertUVtoKnots(u, v) {
                // (m/s * 1.94384) = knots
                return Math.sqrt(u * u + v * v) * 1.94384;
            }
            function convertUVtoDegrees(u, v) {
                // Dirección meteorológica (de dónde viene el viento)
                let degrees = (Math.atan2(u, v) * (180 / Math.PI)) + 180;
                return (degrees + 360) % 360; // Asegurar 0-360
            }


            // --- NUEVA FUNCIÓN: OBTENER VEREDICTO DEL PRONÓSTICO (IA) ---
            async function fetchForecastVerdict() {
                forecastVerdictLoaderEl.style.display = 'block';
                forecastVerdictDataEl.style.display = 'none';

                try {
                    // 1. Get forecast data from Windy API
                    const windyPayload = {
                        lat: -38.860571, // Coordenadas de Claromecó (de api/tides.js)
                        lon: -60.079501,
                        model: "gfs",
                        parameters: ["wind", "temp"], // Pedimos viento y temp
                        levels: ["surface"]
                    };
                    
                    const windyData = await fetchWithBackoff(windyApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(windyPayload)
                    });

                    if (!windyData || !windyData['wind_u-surface']) {
                        throw new Error('Datos de pronóstico (Windy) no válidos.');
                    }

                    // 2. Procesar el dato del pronóstico (usamos 6hs a futuro, índice 2)
                    const forecastIndex = 2; // Índice 2 = ~6 horas
                    const u = windyData['wind_u-surface'][forecastIndex];
                    const v = windyData['wind_v-surface'][forecastIndex];
                    // Windy devuelve temp en Kelvin, la pasamos a Celsius
                    const temp = windyData['temp-surface'][forecastIndex] - 273.15; 

                    const speed = convertUVtoKnots(u, v);
                    const direction = convertUVtoDegrees(u, v);
                    const cardinal = convertDegreesToCardinal(direction);

                    // 3. Obtener el color del veredicto primero (usando la lógica simple)
                    const [fallbackText, verdictColors] = getSpotVerdict(speed, null, direction);
                    updateCardColors(forecastVerdictCardEl, verdictColors); // Poner color a la tarjeta
                    forecastVerdictDataEl.textContent = fallbackText; // Poner texto de fallback

                    // 4. Llamar a Gemini (api/verdict.js) con estos datos del pronóstico
                    const geminiResponse = await fetchWithBackoff(verdictApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            speed: parseFloat(speed.toFixed(1)),
                            gust: null, // El pronóstico GFS de Windy no da racha (gust)
                            direction: parseFloat(direction.toFixed(1)),
                            cardinal: cardinal,
                            temp: parseFloat(temp.toFixed(1))
                        })
                    });

                    if (geminiResponse.verdict) {
                        forecastVerdictDataEl.textContent = geminiResponse.verdict; // Sobrescribir con IA
                    }

                } catch (error) {
                    console.error("Error al generar Veredicto (IA) del Pronóstico:", error);
                    forecastVerdictDataEl.textContent = "Error al analizar pronóstico.";
                    updateCardColors(forecastVerdictCardEl, ['bg-red-400', 'border-red-600']);
                } finally {
                    forecastVerdictLoaderEl.style.display = 'none';
                    forecastVerdictDataEl.style.display = 'block';
                }
            }
            
            // --- FUNCIÓN: OBTENER DATOS DEL CLIMA (ECOWITT) ---
            async function fetchWeatherData() {
                
                showSkeletons(true); // MEJORA UX: Mostrar skeletons
                errorEl.classList.add('hidden'); // Ocultar error antiguo

                let windSpeedValue = null; 
                let windGustValue = null; 
                let windDirDegrees = null;
                let tempValue = null;

                try {
                    const json = await fetchWithBackoff(weatherApiUrl, {});

                    if (json.code === 0 && json.data) {
                        const data = json.data;
                        
                        // Extracción de datos
                        const outdoor = data.outdoor || {};
                        const wind = data.wind || {};
                        const pressure = data.pressure || {};
                        const rainfall = data.rainfall || {}; 
                        const solarUVI = data.solar_and_uvi || {}; 
                        
                        const temp = outdoor.temperature;
                        const humidity = outdoor.humidity;
                        const pressureRel = pressure.relative;
                        const rainfallDaily = rainfall.daily; 
                        const uvi = solarUVI.uvi; 
                        
                        const windSpeed = wind.wind_speed;
                        const windGust = wind.wind_gust;
                        const windDir = wind.wind_direction;
                        
                        // ** LÓGICA DE VIENTO **
                        windSpeedValue = (windSpeed && windSpeed.value !== null) ? parseFloat(windSpeed.value) : null;
                        windGustValue = (windGust && windGust.value !== null) ? parseFloat(windGust.value) : null; 
                        windDirDegrees = (windDir && windDir.value !== null) ? parseFloat(windDir.value) : null;
                        tempValue = (temp && temp.value !== null) ? parseFloat(temp.value) : null;
                        const windDirCardinal = windDirDegrees !== null ? convertDegreesToCardinal(windDirDegrees) : 'N/A';
                        
                        // --- (INICIO DE LÓGICA DE VEREDICTO SIMPLE) ---
                        // (Se eliminó la llamada a Gemini de aquí)
                        const [verdictText, verdictColors] = getSpotVerdict(windSpeedValue, windGustValue, windDirDegrees);
                        
                        // 1. Asignar el color de la tarjeta de veredicto
                        updateCardColors(verdictCardEl, verdictColors);
                        // 2. Asignar el texto de veredicto
                        verdictDataEl.textContent = verdictText;
                        
                        // --- (FIN DE LÓGICA DE VEREDICTO SIMPLE) ---


                        // MEJORA UX: Aplicar rotación Y COLOR (Red/Yellow/Green) a la flecha
                        if (windArrowEl && windDirDegrees !== null) {
                            windArrowEl.style.transform = `rotate(${windDirDegrees}deg)`;
                            
                            // Lógica de color de flecha MEJORADA
                            if (windDirDegrees > 337.5 || windDirDegrees <= 22.5) { // N (Offshore)
                                windArrowEl.classList.remove('text-green-600', 'text-yellow-600', 'text-gray-900');
                                windArrowEl.classList.add('text-red-600');
                            } else if (windDirDegrees > 22.5 && windDirDegrees <= 67.5) { // NNE, NE (Offshore)
                                windArrowEl.classList.remove('text-green-600', 'text-yellow-600', 'text-gray-900');
                                windArrowEl.classList.add('text-red-600');
                            } else if (windDirDegrees > 67.5 && windDirDegrees <= 112.5) { // ENE, E (Cross)
                                windArrowEl.classList.remove('text-green-600', 'text-red-600', 'text-gray-900');
                                windArrowEl.classList.add('text-yellow-600');
                            } else if (windDirDegrees > 112.5 && windDirDegrees <= 247.5) { // ESE, SE, S, SO, OSO (Onshore)
                                windArrowEl.classList.remove('text-red-600', 'text-yellow-600', 'text-gray-900');
                                windArrowEl.classList.add('text-green-600');
                            } else if (windDirDegrees > 247.5 && windDirDegrees <= 292.5) { // O, ONO (Cross)
                                windArrowEl.classList.remove('text-green-600', 'text-red-600', 'text-gray-900');
                                windArrowEl.classList.add('text-yellow-600');
                            } else { // NO, NNO (Lógica Offshore modificada)
                                windArrowEl.classList.remove('text-green-600', 'text-yellow-600', 'text-gray-900');
                                windArrowEl.classList.add('text-red-600');
                            }

                        } else if (windArrowEl) {
                            windArrowEl.classList.remove('text-red-600', 'text-green-600', 'text-yellow-600');
                            windArrowEl.classList.add('text-gray-900');
                        }


                        // Aplicar clase de color al card de viento PRINCIPAL (Neutral)
                        updateCardColors(windHighlightCard, getMainCardColorClasses(windSpeedValue));

                        // Aplicar clase de color a la SUB-TARJETA de velocidad (Lógica Windy)
                        updateCardColors(windSpeedSubCardEl, getWindyColorClasses(windSpeedValue));
                        
                        // Aplicar clase de color a la SUB-TARJETA de ráfaga (Lógica Windy)
                        updateCardColors(windGustSubCardEl, getWindyColorClasses(windGustValue));


                        // Actualizar UI del card de viento
                        highlightWindSpeedEl.textContent = windSpeed ? `${windSpeed.value} ${windSpeed.unit}` : 'N/A';
                        highlightGustEl.textContent = windGust ? `${windGust.value} ${windGust.unit}` : 'N/A';
                        highlightWindDirEl.textContent = windDirCardinal; 

                        // Actualizar UI de datos generales
                        tempEl.textContent = temp ? `${temp.value} ${temp.unit}` : 'N/A';
                        humidityEl.textContent = humidity ? `${humidity.value} ${humidity.unit}` : 'N/A';
                        pressureEl.textContent = pressureRel ? `${pressureRel.value} ${pressureRel.unit}` : 'N/A'; 
                        rainfallDailyEl.textContent = rainfallDaily ? `${rainfallDaily.value} ${rainfallDaily.unit}` : 'N/A'; 
                        uviEl.textContent = uvi ? uvi.value : 'N/A'; 
                        
                        showSkeletons(false); // MEJORA UX: Ocultar skeletons
                        
                        lastUpdateTime = new Date(); // MEJORA UX: Registrar tiempo
                        updateTimeAgo(); // MEJORA UX: Actualizar "Time Ago"

                        // (Llamada a Gemini ELIMINADA de aquí)

                    } else {
                        // Manejar errores de la API de Ecowitt que vienen en el JSON
                        throw new Error(json.msg || 'Formato de datos incorrecto de la fuente.');
                    }
                } catch (error) {
                    console.error('Error al obtener datos del clima:', error);
                    
                    // MEJORA UX: Mostrar error en la tarjeta principal
                    errorEl.textContent = `Error: No se pudieron cargar los datos. (${error.message})`;
                    errorEl.classList.remove('hidden');
                    
                    // Ocultar Skeletons aunque haya error
                    showSkeletons(false);
                    
                    // Resetear la UI a N/A
                    tempEl.textContent = 'N/A';
                    humidityEl.textContent = 'N/A';
                    pressureEl.textContent = 'N/A';
                    rainfallDailyEl.textContent = 'N/A';
                    uviEl.textContent = 'N/A';

                    highlightWindSpeedEl.textContent = 'N/A';
                    highlightGustEl.textContent = 'N/A';
                    highlightWindDirEl.textContent = 'N/A';
                    
                    // Resetear color de la tarjeta a gris (usando las funciones corregidas)
                    updateCardColors(windHighlightCard, getMainCardColorClasses(null));
                    
                    // Resetear color de la SUB-TARJETA a gris (usando las funciones corregidas)
                    updateCardColors(windSpeedSubCardEl, getWindyColorClasses(null));
                    updateCardColors(windGustSubCardEl, getWindyColorClasses(null));

                    // Resetear Veredicto (con error)
                    verdictDataEl.textContent = 'Error en API (Ecowitt)';
                    updateCardColors(verdictCardEl, ['bg-red-400', 'border-red-600']);
                    verdictDataLoaderEl.style.display = 'none'; // Ocultar loader
                    verdictDataEl.style.display = 'block'; // Mostrar error

                    // Resetear flecha
                    if (windArrowEl) {
                        windArrowEl.classList.remove('text-red-600', 'text-green-600', 'text-yellow-600');
                        windArrowEl.classList.add('text-gray-900');
                        windArrowEl.style.transform = 'rotate(0deg)';
                    }
                    
                    if (lastUpdatedEl) lastUpdatedEl.textContent = "Error en la actualización.";
                }
            }
            
            // --- INICIALIZACIÓN ---
            
            // Cargar datos del clima al iniciar
            fetchWeatherData();
            // Cargar el veredicto del pronóstico (IA)
            //fetchForecastVerdict();

            // Actualizar datos cada 30 segundos (30000ms)
            setInterval(fetchWeatherData, 30000);
            
            // MEJORA UX: Actualizar el "Time Ago" cada 5 segundos
            setInterval(updateTimeAgo, 5000);
        });
    </script>

</body>
</html>
